@inherits LayoutComponentBase
@inject AccountService AccountService
@inject IJSRuntime JS

<Header>
    <TitleContent>
        <SectionOutlet SectionId="PageSections.Title" />
    </TitleContent>
    <SubtitleContent>
        <SectionOutlet SectionId="PageSections.Subtitle" />
    </SubtitleContent>
</Header>

<AccountBar CurrentAccount="@currentAccount" OnAccountChanged="@LoadAccount" />

<NavMenu />

<div class="container">
    <CascadingValue Value="@currentAccount">
        @Body
    </CascadingValue>
</div>

@code {
    private Account? currentAccount;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAccount();
        }
    }

    private async Task LoadAccount()
    {
        try
        {
            var sessionJson = await JS.InvokeAsync<string>("localStorage.getItem", "accountSession");
            if (!string.IsNullOrEmpty(sessionJson))
            {
                var session = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, string>>(sessionJson);
                if (session != null && session.ContainsKey("username") && session.ContainsKey("password"))
                {
                    var (success, error, account, sessionToken) = AccountService.Login(session["username"], session["password"]);
                    if (success && account != null)
                    {
                        currentAccount = account;
                    }
                }
            }
        }
        catch
        {
            currentAccount = null;
        }

        await InvokeAsync(StateHasChanged);
    }
}
