@using AIChaos.Brain.Models
@using AIChaos.Brain.Services
@using AIChaos.Brain.Components.Shared.Panels
@implements IDisposable

@inject QueueSlotService QueueSlots
@inject YouTubeService YouTubeService
@inject PromptModerationService ModerationService
@inject RefundService RefundService
@inject CodeModerationService CodeModerationService
@inject CommandQueueService CommandQueue
@inject NavigationManager Navigation

<!-- Global Status Message -->
@if (!string.IsNullOrEmpty(globalMessage))
{
    <div class="alert alert-@globalMessageType" style="margin-bottom: 20px;">@globalMessage</div>
}

<div class="stream-control-grid">
    @if (CurrentAccount?.Role == UserRole.Admin)
    {
        <!-- Queue Control Panel -->
        <QueueControlPanel 
            ActiveSlots="@activeSlots" 
            TotalSlots="@totalSlots" 
            OnStatusChanged="@LoadQueueStatus" />
        
        <!-- Stream Settings Panel -->
        <StreamSettingsPanel 
            IsStreamActive="@isStreamActive" 
            OnStreamStateChanged="@LoadStreamState" />
        
        <!-- Image Moderation Panel -->
        <PromptModerationPanel 
            PendingCount="@pendingPromptCount" 
            OnPromptProcessed="@LoadPendingPromptCount" />
        
        <!-- Refund Requests Panel -->
        <RefundRequestsPanel 
            PendingCount="@pendingRefundCount" 
            OnRefundProcessed="@LoadPendingRefundCount" />
        
        <!-- Code Moderation Panel -->
        <CodeModerationPanel 
            PendingCount="@pendingCodeCount" 
            OnCodeProcessed="@LoadPendingCodeCount" />
        
        <!-- Global History Panel -->
        <GlobalHistoryPanel 
            OnStatusMessage="@HandleStatusMessage" 
            OnHistoryChanged="@StateHasChanged" />
    }
</div>

<style>
    .stream-control-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
</style>

@code {
    [Parameter]
    public Account? CurrentAccount { get; set; }
    
    // Global message
    private string globalMessage = "";
    private string globalMessageType = "info";
    
    // Queue status
    private int activeSlots = 0;
    private int totalSlots = 0;
    private System.Threading.Timer? queueStatusRefreshTimer;
    
    // Stream state
    private bool isStreamActive = false;
    private System.Threading.Timer? streamStateRefreshTimer;
    
    // Pending counts
    private int pendingPromptCount = 0;
    private int pendingRefundCount = 0;
    private int pendingCodeCount = 0;

    protected override async Task OnInitializedAsync()
    {
        // Check for query parameters (success/error messages)
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        if (query["success"] != null)
        {
            globalMessage = query["success"]!;
            globalMessageType = "success";
        }
        else if (query["error"] != null)
        {
            globalMessage = query["error"]!;
            globalMessageType = "error";
        }
        
        await LoadAll();
        
        // Start auto-refresh for queue status
        StartAutoRefreshQueueStatus();
        
        // Start auto-refresh for stream state
        StartStreamStateRefresh();
    }

    private async Task LoadAll()
    {
        await LoadQueueStatus();
        LoadStreamState();
        await LoadPendingPromptCount();
        await LoadPendingRefundCount();
        await LoadPendingCodeCount();
    }

    private async Task LoadQueueStatus()
    {
        try
        {
            var response = QueueSlots.GetStatus();
            if (response != null)
            {
                totalSlots = response.TotalSlots;
                activeSlots = response.OccupiedSlots;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load queue status: {ex.Message}");
        }
        StateHasChanged();
    }

    private void LoadStreamState()
    {
        try
        {
            isStreamActive = YouTubeService.IsListening;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load stream state: {ex.Message}");
        }
        StateHasChanged();
    }

    private async Task LoadPendingPromptCount()
    {
        try
        {
            var prompts = ModerationService.GetPendingPrompts();
            pendingPromptCount = prompts?.Count ?? 0;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load pending prompt count: {ex.Message}");
        }
        StateHasChanged();
    }

    private async Task LoadPendingRefundCount()
    {
        try
        {
            var refunds = RefundService.GetPendingRequests();
            pendingRefundCount = refunds?.Count ?? 0;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load pending refund count: {ex.Message}");
        }
        StateHasChanged();
    }

    private async Task LoadPendingCodeCount()
    {
        try
        {
            var code = CodeModerationService.GetPendingCode();
            pendingCodeCount = code?.Count ?? 0;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load pending code count: {ex.Message}");
        }
        StateHasChanged();
    }

    private void StartAutoRefreshQueueStatus()
    {
        if (queueStatusRefreshTimer == null)
        {
            queueStatusRefreshTimer = new System.Threading.Timer(async _ =>
            {
                await InvokeAsync(async () => await LoadQueueStatus());
            }, null, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(2));
        }
    }

    private void StartStreamStateRefresh()
    {
        if (streamStateRefreshTimer == null)
        {
            streamStateRefreshTimer = new System.Threading.Timer(async _ =>
            {
                try
                {
                    await InvokeAsync(() =>
                    {
                        var newState = YouTubeService.IsListening;
                        if (newState != isStreamActive)
                        {
                            isStreamActive = newState;
                            StateHasChanged();
                        }
                    });
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error refreshing stream state: {ex.Message}");
                }
            }, null, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(2));
        }
    }

    private async Task HandleStatusMessage(string message)
    {
        if (string.IsNullOrEmpty(message)) return;
        
        var parts = message.Split(':', 2);
        if (parts.Length == 2)
        {
            globalMessageType = parts[0];
            globalMessage = parts[1];
        }
        else
        {
            globalMessageType = "info";
            globalMessage = message;
        }
        
        StateHasChanged();
        
        // Clear message after delay
        _ = Task.Run(async () =>
        {
            await Task.Delay(Constants.MessageDurations.Medium);
            await InvokeAsync(() =>
            {
                globalMessage = "";
                StateHasChanged();
            });
        });
    }

    public void Dispose()
    {
        queueStatusRefreshTimer?.Dispose();
        queueStatusRefreshTimer = null;
        streamStateRefreshTimer?.Dispose();
        streamStateRefreshTimer = null;
    }
}
