@using AIChaos.Brain.Services
@using AIChaos.Brain.Models
@implements IDisposable
@inject ImageModerationService ModerationService

<!-- Pending Links -->
<div class="card moderation-section">
    <h2>üîó Incoming Links <span class="badge">@PendingCount</span></h2>
    <div style="margin-bottom: 15px;">
        <button @onclick="RefreshImages" class="btn-secondary">üîÑ Refresh</button>
        <label style="display: inline-flex; align-items: center; gap: 8px; margin-left: 10px; cursor: pointer;">
            <input type="checkbox" @bind="autoRefresh" @bind:after="ToggleAutoRefresh">
            <span style="color: var(--text-dim); font-size: 14px;">Auto (5s)</span>
        </label>
    </div>
    
    @if (pendingImages == null || !pendingImages.Any())
    {
        <div class="empty-state">‚úÖ No links pending</div>
    }
    else
    {
        <div class="image-list">
            @foreach (var img in pendingImages)
            {
                <div class="image-card-compact">
                    <div class="image-info">
                        <span class="image-id">#@img.Id</span>
                        <span class="image-author">üë§ @img.Author</span>
                    </div>
                    <div class="image-prompt">@img.UserPrompt</div>
                    <div class="link-url" style="word-break: break-all; font-size: 12px; margin-bottom: 10px;">
                        üîó <a href="@img.ImageUrl" target="_blank" rel="noopener noreferrer" style="color: var(--info); text-decoration: underline;">@img.ImageUrl</a>
                    </div>
                    <div class="image-actions">
                        <button @onclick="() => ApproveImage(img.Id)" class="btn-success btn-small">‚úÖ</button>
                        <button @onclick="() => DenyImage(img.Id)" class="btn-danger btn-small">‚ùå</button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public int PendingCount { get; set; }
    [Parameter] public EventCallback OnImageProcessed { get; set; }
    
    private List<PendingImageEntry>? pendingImages;
    private bool autoRefresh = false;
    private System.Threading.Timer? refreshTimer;
    
    protected override async Task OnInitializedAsync()
    {
        await RefreshImages();
    }
    
    private async Task RefreshImages()
    {
        try
        {
            pendingImages = ModerationService.GetPendingImages();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load pending images: {ex.Message}");
        }
    }
    
    private void ToggleAutoRefresh()
    {
        if (autoRefresh)
        {
            refreshTimer = new System.Threading.Timer(async _ =>
            {
                await InvokeAsync(async () => await RefreshImages());
            }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
        }
        else
        {
            refreshTimer?.Dispose();
            refreshTimer = null;
        }
    }
    
    private async Task ApproveImage(int imageId)
    {
        try
        {
            ModerationService.ApproveImage(imageId);
            await RefreshImages();
            await OnImageProcessed.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to approve image: {ex.Message}");
        }
    }
    
    private async Task DenyImage(int imageId)
    {
        try
        {
            ModerationService.DenyImage(imageId);
            await RefreshImages();
            await OnImageProcessed.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to deny image: {ex.Message}");
        }
    }
    
    public void Dispose()
    {
        refreshTimer?.Dispose();
        refreshTimer = null;
    }
}
